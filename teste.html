import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch } from 'firebase/firestore';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  Search, Youtube, Copy, Dumbbell, CheckCircle2, 
  Plus, X, Trash2, Loader2, Save, Database, 
  Zap, Edit2, Download, FileJson 
} from 'lucide-react';

// Configurações do Firebase
const firebaseConfig = JSON.parse(__firebase_config);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dmx-exercicios-cloud';
const CUSTOM_LOGO_URL = "https://i.imgur.com/rLLYQ3Z.png"; 

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const App = () => {
  const [user, setUser] = useState(null);
  const [exercises, setExercises] = useState([]);
  const [loading, setLoading] = useState(true);
  const [syncing, setSyncing] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeCategory, setActiveCategory] = useState('Todos');
  const [copiedId, setCopiedId] = useState(null);
  const [showAdminPanel, setShowAdminPanel] = useState(false);
  const [adminTab, setAdminTab] = useState('single');
  const [batchInput, setBatchInput] = useState('');
  const [isAdmin, setIsAdmin] = useState(true);
  const [editingId, setEditingId] = useState(null);

  const [form, setForm] = useState({
    id: '', name: '', category: 'Quadríceps', muscleGroups: '', youtubeUrl: '', thumbnail: '', keywords: ''
  });

  const categories = [
    'Todos', 'Quadríceps', 'Posteriores', 'Glúteos', 'Adutores', 'Panturrilha', 
    'Peitoral', 'Costas', 'Ombros', 'Bíceps', 'Tríceps', 'Antebraço', 'Core'
  ];

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    if (params.get('admin') === 'dmx2026') setIsAdmin(true);
  }, []);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) { console.error("Erro auth:", error); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'exercises');
    return onSnapshot(ref, (snap) => {
      setExercises(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() })));
      setLoading(false);
    }, (err) => {
      console.error("Erro Firestore:", err);
      setLoading(false);
    });
  }, [user]);

  const filteredExercises = useMemo(() => {
    return exercises.filter(ex => {
      const s = searchTerm.toLowerCase();
      const matchesSearch = 
        ex.id?.toLowerCase().includes(s) || 
        ex.name?.toLowerCase().includes(s) ||
        (Array.isArray(ex.keywords) && ex.keywords.some(k => k.toLowerCase().includes(s)));
      const matchesCat = activeCategory === 'Todos' || ex.category === activeCategory;
      return matchesSearch && matchesCat;
    });
  }, [searchTerm, activeCategory, exercises]);

  const handleOpenCreate = () => {
    setEditingId(null);
    setForm({ id: '', name: '', category: 'Quadríceps', muscleGroups: '', youtubeUrl: '', thumbnail: '', keywords: '' });
    setAdminTab('single');
    setShowAdminPanel(true);
  };

  const handleOpenEdit = (ex) => {
    setEditingId(ex.firestoreId);
    setForm({
      id: ex.id || '',
      name: ex.name || '',
      category: ex.category || 'Quadríceps',
      muscleGroups: Array.isArray(ex.muscleGroups) ? ex.muscleGroups.join(', ') : '',
      youtubeUrl: ex.youtubeUrl || '',
      thumbnail: ex.thumbnail || '',
      keywords: Array.isArray(ex.keywords) ? ex.keywords.join(', ') : ''
    });
    setAdminTab('single');
    setShowAdminPanel(true);
  };

  const handleSave = async (e) => {
    e.preventDefault();
    try {
      const dataToSave = {
        ...form,
        muscleGroups: form.muscleGroups.split(',').map(m => m.trim()).filter(m => m !== ""),
        keywords: form.keywords.split(',').map(k => k.trim()).filter(k => k !== ""),
        updatedAt: new Date().toISOString()
      };

      if (editingId) {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exercises', editingId);
        await updateDoc(docRef, dataToSave);
      } else {
        const ref = collection(db, 'artifacts', appId, 'public', 'data', 'exercises');
        await addDoc(ref, { ...dataToSave, createdAt: new Date().toISOString() });
      }

      setShowAdminPanel(false);
      setEditingId(null);
    } catch (error) { console.error("Erro ao salvar:", error); }
  };

  const exportData = () => {
    const dataStr = JSON.stringify(exercises, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `backup_dmx_${new Date().toISOString().split('T')[0]}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  const handleBatchImport = async () => {
    if (!batchInput.trim()) return;
    setSyncing(true);
    try {
      const data = JSON.parse(batchInput);
      const batch = writeBatch(db);
      const ref = collection(db, 'artifacts', appId, 'public', 'data', 'exercises');

      data.forEach(item => {
        const docRef = doc(ref);
        batch.set(docRef, {
          ...item,
          muscleGroups: Array.isArray(item.muscleGroups) ? item.muscleGroups : item.muscleGroups?.split(',').map(m => m.trim()) || [],
          keywords: Array.isArray(item.keywords) ? item.keywords : item.keywords?.split(',').map(k => k.trim()) || [],
          createdAt: new Date().toISOString()
        });
      });

      await batch.commit();
      setBatchInput('');
      setShowAdminPanel(false);
    } catch (error) {
      alert("Erro de formato no JSON.");
    } finally {
      setSyncing(false);
    }
  };

  const copy = (url, id) => {
    const textField = document.createElement('textarea');
    textField.innerText = url;
    document.body.appendChild(textField);
    textField.select();
    document.execCommand('copy');
    textField.remove();
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  return (
    <div className="min-h-screen bg-[#000000] text-white p-2 sm:p-4 font-sans selection:bg-red-600 selection:text-white">
      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
      `}</style>

      {/* Header Compactado */}
      <header className="max-w-7xl mx-auto flex flex-col lg:flex-row items-center justify-between gap-4 mb-6 pt-2">
        <div className="flex items-center gap-3 self-start lg:self-center">
          <img src={CUSTOM_LOGO_URL} className="h-10 w-10 sm:h-14 sm:w-14 object-contain" alt="DMX Logo" />
          <div className="flex flex-col">
            <h1 className="text-xl sm:text-2xl font-black italic uppercase tracking-tighter leading-none">BIBLIOTECA <span className="text-red-600">DMX</span></h1>
            <span className="text-[8px] font-bold text-gray-500 tracking-[0.3em] uppercase mt-1">Performance Cloud</span>
          </div>
        </div>

        <div className="flex flex-col sm:flex-row w-full lg:flex-1 lg:max-w-2xl gap-3">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 w-4 h-4" />
            <input 
              type="text" 
              placeholder="Buscar exercício..." 
              className="w-full pl-10 pr-4 py-3 bg-[#111] border border-white/5 rounded-xl outline-none focus:border-red-600 transition-all text-xs sm:text-sm placeholder:text-gray-600" 
              value={searchTerm} 
              onChange={e => setSearchTerm(e.target.value)} 
            />
          </div>

          {isAdmin && (
            <button onClick={handleOpenCreate} className="bg-red-600 px-4 py-3 rounded-xl font-black flex items-center justify-center gap-2 hover:bg-red-700 transition-all text-[10px] uppercase tracking-widest whitespace-nowrap">
              <Database className="w-4 h-4" /> GESTÃO
            </button>
          )}
        </div>
      </header>

      {/* Categorias Suaves */}
      <div className="max-w-7xl mx-auto mb-6">
        <div className="flex gap-2 overflow-x-auto py-1 no-scrollbar scroll-smooth">
          {categories.map(cat => (
            <button 
              key={cat} 
              onClick={() => setActiveCategory(cat)} 
              className={`px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all whitespace-nowrap border ${
                activeCategory === cat 
                ? 'bg-red-600 border-red-600 text-white shadow-md' 
                : 'bg-[#0a0a0a] border-white/5 text-gray-400 hover:border-red-600/50 hover:text-white'
              }`}
            >
              {cat}
            </button>
          ))}
        </div>
      </div>

      {/* Grid Principal Adaptativo */}
      <main className="max-w-7xl mx-auto">
        {loading ? (
          <div className="flex flex-col items-center justify-center py-20">
            <Loader2 className="w-8 h-8 animate-spin text-red-600 mb-4" />
            <p className="text-[9px] font-black uppercase tracking-widest text-gray-500">Carregando Atlas...</p>
          </div>
        ) : (
          <div className="grid grid-cols-2 xs:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-5">
            {filteredExercises.map((ex, index) => (
              <div 
                key={ex.firestoreId} 
                className="group relative bg-[#0a0a0a] rounded-[1.5rem] sm:rounded-[2.5rem] border border-white/5 overflow-hidden flex flex-col transition-all hover:border-red-600/50 animate-fade-in"
                style={{ animationDelay: `${index * 30}ms` }}
              >
                <div className="aspect-[9/16] bg-zinc-900 relative overflow-hidden">
                  <img 
                    src={ex.thumbnail || `https://i.ytimg.com/vi/${ex.youtubeUrl.includes('v=') ? ex.youtubeUrl.split('v=')[1].split('&')[0] : (ex.youtubeUrl.split('/').pop())}/hqdefault.jpg`} 
                    className="w-full h-full object-cover opacity-40 group-hover:opacity-100 transition-all duration-500" 
                    onError={(e) => { e.target.src = "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=400"; }} 
                    alt={ex.name}
                  />
                  <div className="absolute inset-0 bg-gradient-to-t from-[#000000] via-transparent to-transparent" />
                  
                  <div className="absolute top-3 left-3 sm:top-5 sm:left-5">
                    <div className="bg-red-600 text-white text-[8px] sm:text-[10px] font-black px-2 py-0.5 rounded sm:rounded-lg uppercase italic border border-white/10 shadow-lg shadow-red-600/20">
                      #{ex.id}
                    </div>
                  </div>

                  <div className="absolute bottom-3 left-3 right-3 sm:bottom-5 sm:left-5 sm:right-5">
                    <p className="text-[7px] sm:text-[9px] font-black text-red-600 uppercase tracking-widest mb-0.5 italic opacity-80">{ex.category}</p>
                    <h3 className="font-bold text-[10px] sm:text-sm leading-tight uppercase italic text-white line-clamp-2">{ex.name}</h3>
                  </div>

                  {isAdmin && (
                    <div className="absolute top-3 right-3 sm:top-5 sm:right-5 flex flex-col gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-200">
                      <button onClick={() => handleOpenEdit(ex)} className="p-2 bg-white/10 hover:bg-white text-white hover:text-black rounded-lg backdrop-blur-md transition-all shadow-xl">
                        <Edit2 className="w-3 h-3 sm:w-4 sm:h-4" />
                      </button>
                      <button onClick={() => {if(confirm("Excluir?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'exercises', ex.firestoreId))}} className="p-2 bg-red-600/20 hover:bg-red-600 text-white rounded-lg backdrop-blur-md transition-all shadow-xl">
                        <Trash2 className="w-3 h-3 sm:w-4 sm:h-4" />
                      </button>
                    </div>
                  )}
                </div>
                
                <div className="p-2 sm:p-4 grid grid-cols-4 gap-1.5 bg-[#0a0a0a]">
                  <a href={ex.youtubeUrl} target="_blank" rel="noopener noreferrer" className="col-span-3 bg-white text-black py-2.5 sm:py-3.5 rounded-xl sm:rounded-2xl flex items-center justify-center gap-1.5 font-black text-[8px] sm:text-[10px] hover:bg-red-600 hover:text-white transition-all uppercase italic">
                    <Youtube className="w-3 h-3 sm:w-4 sm:h-4" /> VÍDEO
                  </a>
                  <button onClick={() => copy(ex.youtubeUrl, ex.firestoreId)} className={`rounded-xl sm:rounded-2xl flex items-center justify-center border transition-all ${copiedId === ex.firestoreId ? 'bg-green-600 border-green-500 text-white' : 'bg-[#111] border-white/10 text-gray-500 hover:border-red-600'}`}>
                    {copiedId === ex.firestoreId ? <CheckCircle2 className="w-3 h-3 sm:w-5 sm:h-5" /> : <Copy className="w-3 h-3 sm:w-5 sm:h-5" />}
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Painel Administrativo Adaptável */}
      {showAdminPanel && isAdmin && (
        <div className="fixed inset-0 bg-black/98 backdrop-blur-xl z-50 flex items-center justify-center p-2 sm:p-4 overflow-y-auto">
          <div className="bg-[#0a0a0a] w-full max-w-2xl rounded-[2rem] sm:rounded-[3.5rem] border border-white/5 p-6 sm:p-10 shadow-3xl relative my-auto">
            <div className="flex justify-between items-center mb-6 sm:mb-10">
              <div className="flex gap-4 sm:gap-8 overflow-x-auto no-scrollbar">
                <button onClick={() => !editingId && setAdminTab('single')} className={`text-[10px] sm:text-xs font-black uppercase tracking-widest transition-all pb-2 whitespace-nowrap ${adminTab === 'single' ? 'text-red-600 border-b-2 border-red-600' : 'text-gray-600'}`}>
                  {editingId ? 'Editar Dados' : 'Novo Registro'}
                </button>
                {!editingId && (
                  <button onClick={() => setAdminTab('batch')} className={`text-[10px] sm:text-xs font-black uppercase tracking-widest transition-all pb-2 whitespace-nowrap ${adminTab === 'batch' ? 'text-red-600 border-b-2 border-red-600' : 'text-gray-600'}`}>Importação JSON</button>
                )}
              </div>
              <button onClick={() => setShowAdminPanel(false)} className="p-2 bg-white/5 hover:bg-red-600 text-white rounded-lg transition-all"><X className="w-4 h-4" /></button>
            </div>

            {adminTab === 'single' ? (
              <form onSubmit={handleSave} className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <div className="space-y-1">
                   <label className="text-[8px] font-black uppercase text-gray-600 ml-2 tracking-widest">ID</label>
                   <input required className="w-full bg-white/5 p-3 sm:p-4 rounded-xl border border-white/10 outline-none focus:border-red-600 text-xs" value={form.id} onChange={e => setForm({...form, id: e.target.value})} />
                </div>
                <div className="space-y-1">
                   <label className="text-[8px] font-black uppercase text-gray-600 ml-2 tracking-widest">Nome</label>
                   <input required className="w-full bg-white/5 p-3 sm:p-4 rounded-xl border border-white/10 outline-none focus:border-red-600 text-xs" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                </div>
                <div className="space-y-1">
                   <label className="text-[8px] font-black uppercase text-gray-600 ml-2 tracking-widest">Categoria</label>
                   <select className="w-full bg-white/5 p-3 sm:p-4 rounded-xl border border-white/10 outline-none focus:border-red-600 text-xs appearance-none" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                     {categories.slice(1).map(c => <option key={c} value={c} className="bg-black">{c}</option>)}
                   </select>
                </div>
                <div className="space-y-1">
                   <label className="text-[8px] font-black uppercase text-gray-600 ml-2 tracking-widest">YouTube</label>
                   <input required className="w-full bg-white/5 p-3 sm:p-4 rounded-xl border border-white/10 outline-none focus:border-red-600 text-xs" value={form.youtubeUrl} onChange={e => setForm({...form, youtubeUrl: e.target.value})} />
                </div>
                <div className="sm:col-span-2 space-y-1">
                   <label className="text-[8px] font-black uppercase text-gray-600 ml-2 tracking-widest">Keywords (p/ busca)</label>
                   <textarea className="w-full bg-white/5 p-3 sm:p-4 rounded-xl border border-white/10 outline-none focus:border-red-600 min-h-[60px] text-xs" value={form.keywords} onChange={e => setForm({...form, keywords: e.target.value})} />
                </div>
                <button type="submit" className="sm:col-span-2 bg-red-600 py-4 rounded-2xl font-black uppercase tracking-[0.2em] hover:bg-red-700 text-[10px] mt-2">
                  {editingId ? 'SALVAR ALTERAÇÕES' : 'SALVAR NO ATLAS'}
                </button>
              </form>
            ) : (
              <div className="flex flex-col gap-4">
                <button onClick={exportData} className="flex items-center justify-center gap-2 text-[10px] font-black text-white hover:text-red-600 transition-colors uppercase border border-white/10 p-3 rounded-xl">
                  <Download className="w-4 h-4" /> Exportar Backup
                </button>
                <textarea placeholder='Cole o JSON aqui...' className="w-full bg-black p-4 rounded-2xl border border-white/10 min-h-[150px] text-[10px] font-mono text-zinc-400 outline-none" value={batchInput} onChange={e => setBatchInput(e.target.value)} />
                <button onClick={handleBatchImport} disabled={syncing} className="bg-red-600 py-4 rounded-2xl font-black uppercase tracking-widest flex items-center justify-center gap-2 disabled:opacity-50 text-[10px]">
                  {syncing ? <Loader2 className="animate-spin w-4 h-4" /> : <Zap className="w-4 h-4" />}
                  IMPORTAR AGORA
                </button>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
